<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Mensajes Recibidos</title>
  <link rel="stylesheet" href="css/styles.css" />
  <style>
    .messages-container {
      max-width: 800px;
      margin: auto;
      background: white;
      border-radius: 8px;
      padding: 2rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .message-item {
      border-bottom: 1px solid #eee;
      padding: 1rem 0;
      position: relative;
    }

    .message-item:last-child {
      border-bottom: none;
    }

    .message-item strong {
      display: block;
      color: #0d47a1;
      font-size: 1.1rem;
    }

    .message-item small {
      display: block;
      color: #888;
      margin: 0.5rem 0 1rem 0;
      font-size: 0.9rem;
    }

    .btn-delete {
      position: absolute;
      right: 0;
      top: 1rem;
      background: #e53935;
      color: white;
      border: none;
      padding: 0.4rem 0.8rem;
      border-radius: 4px;
      cursor: pointer;
    }

    .btn-delete:hover {
      background: #c62828;
    }

    .empty-state {
      text-align: center;
      padding: 3rem;
      background: #f9f9f9;
      border-radius: 8px;
      margin: 2rem auto;
      max-width: 600px;
    }

    .empty-state svg {
      width: 80px;
      height: 80px;
      margin: auto;
      opacity: 0.5;
      display: block;
      margin-bottom: 1rem;
    }

    .empty-state h3 {
      font-size: 1.2rem;
      color: #555;
      margin-bottom: 1rem;
    }

    .empty-state p {
      color: #888;
    }
  </style>
</head>
<body>

  <!-- Header -->
  <header class="site-header">
    <div class="logo">Municipio Ejemplo</div>
    <nav class="main-nav">
      <ul>
        <li><a href="../index.html">Inicio</a></li>
        <li><a href="../noticias.html">Noticias</a></li>
        <li><a href="#" class="active">Mensajes</a></li>
        <li><a href="../admin/login.html" class="btn-admin">Admin</a></li>
      </ul>
    </nav>
  </header>

  <!-- Hero -->
  <section class="hero">
    <h1>Mensajes del Formulario de Contacto</h1>
    <p>Revisa y elimina los mensajes recibidos.</p>
  </section>

  <!-- Contenido -->
  <section class="section">
    <div id="messages-container" class="messages-container"></div>
  </section>

  <!-- Footer -->
  <footer class="site-footer">
    <p>&copy; 2025 Municipio Ejemplo</p>
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const container = document.getElementById('messages-container');

      try {
        const res = await fetch('http://localhost:3001/api/messages');
        const messages = await res.json();

        if (!res.ok) {
          container.innerHTML = `
            <div class="empty-state">
              <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15a2 2 0 0 1-2 2H7l-5 5V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
              </svg>
              <h3>No se pueden cargar los mensajes</h3>
              <p>${messages.error || 'Hubo un problema al obtener los datos.'}</p>
            </div>
          `;
          return;
        }

        if (messages.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15a2 2 0 0 1-2 2H7l-5 5V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
              </svg>
              <h3>No hay mensajes aún</h3>
              <p>Los mensajes aparecerán aquí después de ser enviados desde el formulario de contacto.</p>
            </div>
          `;
          return;
        }

        let html = '';
        messages.forEach(msg => {
          html += `
            <div class="message-item" data-id="${msg.id}">
              <strong>${msg.nombre}</strong>
              <small>${msg.email} – ${new Date(msg.fecha).toLocaleString()}</small>
              <p>${msg.mensaje}</p>
              <button class="btn-delete" onclick="deleteMessage(${msg.id})">Eliminar</button>
            </div>
          `;
        });

        container.innerHTML = html;

      } catch (err) {
        container.innerHTML = `
          <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15a2 2 0 0 1-2 2H7l-5 5V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
            <h3>Error de conexión</h3>
            <p>No se pudieron cargar los mensajes. (${err.message})</p>
          </div>
        `;
        console.error(err);
      }
    });

    async function deleteMessage(id) {
      const token = localStorage.getItem('token') || '';

      if (!confirm('¿Estás seguro de eliminar este mensaje?')) return;

      try {
        const res = await fetch(`http://localhost:3001/api/messages/${id}`, {
          method: 'DELETE',
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });

        if (res.ok) {
          alert('✅ Mensaje eliminado correctamente');
          location.reload();
        } else {
          alert('❌ Hubo un error al eliminar el mensaje.');
        }
      } catch (err) {
        alert('⚠️ No se pudo conectar con el servidor.');
        console.error(err);
      }
    }
  </script>
</body>
</html>